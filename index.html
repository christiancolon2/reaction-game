<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>REACTION.IO // Professional Reaction Timer</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@500;700&display=swap"
      rel="stylesheet"
    />

    <!-- Three.js CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <style>
      /* ========================================
        DESIGN SYSTEM & CSS
        ========================================
        */
      :root {
        --bg-color: #0f0f13;
        --surface-color: #1c1c24;
        --border-color: #2e2e3a;
        --accent-color: #00f5a0;
        --error-color: #ff4d6d;
        --text-primary: #f0f0f5;
        --text-secondary: #7f7f9a;
        --font-main: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
        --font-mono: "JetBrains Mono", monospace;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        user-select: none;
      }

      body {
        background-color: var(--bg-color);
        color: var(--text-primary);
        font-family: var(--font-main);
        overflow: hidden;
        height: 100vh;
        width: 100vw;
      }

      #canvas-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1;
      }

      /* Top Right Score Badge */
      #top-score-display {
        position: fixed;
        top: 2rem;
        right: 2rem;
        z-index: 100;
        background: rgba(28, 28, 36, 0.8);
        backdrop-filter: blur(12px);
        padding: 1rem 1.5rem;
        border-radius: 16px;
        border: 1px solid var(--border-color);
        text-align: right;
        transition:
          transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275),
          opacity 0.3s ease;
        opacity: 0;
        transform: translateX(20px);
        pointer-events: none;
      }

      #top-score-display.visible {
        opacity: 1;
        transform: translateX(0);
      }

      .score-label {
        font-size: 0.65rem;
        text-transform: uppercase;
        color: var(--text-secondary);
        letter-spacing: 0.1em;
        margin-bottom: 0.2rem;
      }

      .score-value {
        font-family: var(--font-mono);
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--accent-color);
      }

      /* Bottom Left Statistics Box */
      #bottom-stats-display {
        position: fixed;
        bottom: 2rem;
        left: 2rem;
        z-index: 100;
        background: rgba(28, 28, 36, 0.8);
        backdrop-filter: blur(12px);
        padding: 1.5rem;
        border-radius: 20px;
        border: 1px solid var(--border-color);
        width: 240px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      }

      #bottom-stats-display h3 {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: var(--text-secondary);
        margin-bottom: 1rem;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 0.5rem;
      }

      .stat-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
      }

      .stat-row span:first-child {
        color: var(--text-secondary);
      }

      .stat-row span:last-child {
        font-family: var(--font-mono);
        color: var(--accent-color);
        font-weight: 600;
      }

      #ui-layer {
        position: relative;
        z-index: 10;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        pointer-events: none;
      }

      /* Main Trigger Box */
      #trigger-box {
        width: 280px;
        height: 280px;
        border-radius: 40px;
        border: 2px dashed rgba(127, 127, 154, 0.3);
        background: rgba(255, 255, 255, 0.02);
        backdrop-filter: blur(4px);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        pointer-events: auto;
        position: relative;
        z-index: 20;
        margin-top: 2rem;
      }

      #trigger-box:hover {
        background: rgba(255, 255, 255, 0.05);
        border-color: rgba(127, 127, 154, 0.5);
      }

      #trigger-box.waiting {
        border: 2px solid var(--border-color);
        background: rgba(28, 28, 36, 0.4);
        animation: pulse-border 2s infinite;
      }

      #trigger-box.ready {
        background: rgba(0, 245, 160, 0.15);
        border: 2px solid var(--accent-color);
        box-shadow: 0 0 40px rgba(0, 245, 160, 0.2);
        transform: scale(1.05);
      }

      #trigger-box.error {
        background: rgba(255, 77, 109, 0.15);
        border: 2px solid var(--error-color);
        animation: shake 0.4s ease-in-out;
      }

      @keyframes pulse-border {
        0% {
          border-color: var(--border-color);
        }
        50% {
          border-color: var(--text-secondary);
        }
        100% {
          border-color: var(--border-color);
        }
      }

      @keyframes shake {
        0%,
        100% {
          transform: translateX(0);
        }
        25% {
          transform: translateX(-10px);
        }
        75% {
          transform: translateX(10px);
        }
      }

      .trigger-text {
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.2em;
        color: var(--text-secondary);
        font-weight: 600;
      }

      /* Modal Containers */
      .modal {
        pointer-events: auto;
        width: 90%;
        max-width: 440px;
        background: rgba(28, 28, 36, 0.95);
        backdrop-filter: blur(20px);
        border: 1px solid var(--border-color);
        border-radius: 32px;
        padding: 2.5rem;
        box-shadow: 0 30px 60px rgba(0, 0, 0, 0.6);
        position: absolute;
        z-index: 50;
        text-align: center;
      }

      .screen {
        display: none;
      }
      .screen.active {
        display: block;
        animation: fadeIn 0.4s ease-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: scale(0.95);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }

      h1 {
        font-size: 1.8rem;
        font-weight: 800;
        margin-bottom: 0.5rem;
      }
      .sub-text {
        color: var(--text-secondary);
        margin-bottom: 2rem;
        line-height: 1.5;
      }

      .instruction-list {
        list-style: none;
        margin-bottom: 2rem;
        text-align: left;
      }
      .instruction-list li {
        position: relative;
        padding-left: 1.5rem;
        margin-bottom: 0.8rem;
        font-size: 0.95rem;
      }
      .instruction-list li::before {
        content: "â†’";
        position: absolute;
        left: 0;
        color: var(--accent-color);
      }

      .btn-group {
        display: flex;
        gap: 1rem;
        margin-top: 1rem;
      }

      .btn {
        background: var(--accent-color);
        color: #000;
        border: none;
        padding: 1.2rem;
        font-size: 1rem;
        font-weight: 800;
        border-radius: 16px;
        cursor: pointer;
        transition: all 0.2s ease;
        text-transform: uppercase;
        width: 100%;
      }

      .btn:hover {
        transform: translateY(-2px);
        filter: brightness(1.1);
        box-shadow: 0 10px 20px rgba(0, 245, 160, 0.2);
      }

      .btn-no {
        background: transparent;
        border: 1px solid var(--border-color);
        color: var(--text-primary);
      }

      .btn-no:hover {
        background: rgba(255, 77, 109, 0.1);
        border-color: var(--error-color);
        color: var(--error-color);
      }

      .stats-summary {
        display: flex;
        justify-content: space-between;
        margin-top: 2rem;
        padding-top: 1.5rem;
        border-top: 1px solid var(--border-color);
      }

      .summary-item {
        text-align: center;
      }
      .summary-label {
        font-size: 0.6rem;
        text-transform: uppercase;
        color: var(--text-secondary);
        display: block;
      }
      .summary-value {
        font-family: var(--font-mono);
        font-weight: 700;
        color: var(--text-primary);
      }

      .rating-tag {
        display: inline-block;
        padding: 0.3rem 0.8rem;
        border-radius: 100px;
        font-size: 0.7rem;
        font-weight: 800;
        text-transform: uppercase;
        margin-bottom: 1rem;
      }

      .superhuman {
        background: #ffd700;
        color: #000;
      }
      .excellent {
        background: var(--accent-color);
        color: #000;
      }
      .good {
        background: #00b4d8;
        color: #fff;
      }
      .average {
        background: #7f7f9a;
        color: #fff;
      }
      .bad {
        background: #ff4d6d;
        color: #fff;
      }

      @media (max-width: 480px) {
        #top-score-display {
          top: 1rem;
          right: 1rem;
          padding: 0.8rem 1rem;
        }
        #bottom-stats-display {
          bottom: 1rem;
          left: 1rem;
          width: calc(100% - 2rem);
        }
        .score-value {
          font-size: 1.2rem;
        }
        #trigger-box {
          width: 220px;
          height: 220px;
        }
      }
    </style>
  </head>
  <body>
    <div id="canvas-container"></div>

    <!-- Top Right Persistent Score -->
    <div id="top-score-display">
      <div class="score-label" id="top-score-label">Last Reaction</div>
      <div class="score-value" id="top-score-value">0ms</div>
      <div id="top-rating-container"></div>
    </div>

    <!-- Bottom Left Persistent Session Statistics -->
    <div id="bottom-stats-display">
      <h3>Session Statistics</h3>
      <div class="stat-row">
        <span>Attempts:</span>
        <span id="btm-stat-trials">0</span>
      </div>
      <div class="stat-row">
        <span>Best Time:</span>
        <span id="btm-stat-best">--</span>
      </div>
      <div class="stat-row">
        <span>Average:</span>
        <span id="btm-stat-avg">--</span>
      </div>
    </div>

    <div id="ui-layer">
      <!-- Center Interaction Box -->
      <div id="trigger-box" onclick="game.handleTriggerClick()">
        <span class="trigger-text" id="trigger-label">Click to Start</span>
      </div>

      <!-- Instruction Modal -->
      <div id="screen-start" class="modal screen active">
        <h1>Reaction.io</h1>
        <p class="sub-text">A professional reflex benchmark.</p>

        <ul class="instruction-list">
          <li>Watch the knot in the center</li>
          <li>Wait for the box to pulse green</li>
          <li>Click the box as fast as possible</li>
          <li>Avoid clicking too early</li>
        </ul>

        <button class="btn" onclick="game.startRound()">Initialize</button>

        <div class="stats-summary">
          <div class="summary-item">
            <span class="summary-label">Best</span>
            <span id="stat-best" class="summary-value">--</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Average</span>
            <span id="stat-avg" class="summary-value">--</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Total</span>
            <span id="stat-trials" class="summary-value">0</span>
          </div>
        </div>
      </div>

      <!-- Round Result Modal -->
      <div id="screen-result" class="modal screen">
        <h1 id="res-modal-title">Round Complete</h1>
        <div id="res-modal-rating"></div>
        <p class="sub-text" id="res-modal-text">Continue to the next trial?</p>
        <div class="btn-group">
          <button class="btn" onclick="game.startRound()">Yes</button>
          <button class="btn btn-no" onclick="game.goToMainMenu()">No</button>
        </div>
      </div>

      <!-- False Start Modal -->
      <div id="screen-error" class="modal screen">
        <h1 style="color: var(--error-color)">False Start</h1>
        <p class="sub-text">
          You clicked too early. Patience is key to precision. Continue?
        </p>
        <div class="btn-group">
          <button class="btn" onclick="game.startRound()">Yes</button>
          <button class="btn btn-no" onclick="game.goToMainMenu()">No</button>
        </div>
      </div>
    </div>

    <script>
      /**
       * SCENE MANAGER
       * Handles the complex Torus Knot visualization.
       */
      class SceneManager {
        constructor() {
          this.container = document.getElementById("canvas-container");
          this.scene = new THREE.Scene();
          this.camera = new THREE.PerspectiveCamera(
            75,
            window.innerWidth / window.innerHeight,
            0.1,
            1000,
          );
          this.renderer = new THREE.WebGLRenderer({
            antialias: true,
            alpha: true,
          });

          this.renderer.setSize(window.innerWidth, window.innerHeight);
          this.renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
          this.container.appendChild(this.renderer.domElement);

          this.initLights();
          this.initObjects();
          this.camera.position.z = 5;

          this.state = "IDLE";
          this.clock = new THREE.Clock();

          window.addEventListener("resize", () => this.onWindowResize());
          this.animate();
        }

        initLights() {
          const ambientLight = new THREE.AmbientLight(0xffffff, 0.2);
          this.scene.add(ambientLight);

          this.pointLight = new THREE.PointLight(0x00f5a0, 2);
          this.pointLight.position.set(5, 5, 5);
          this.scene.add(this.pointLight);

          const blueLight = new THREE.PointLight(0x4a90e2, 1.5);
          blueLight.position.set(-5, -2, 2);
          this.scene.add(blueLight);
        }

        initObjects() {
          const knotGeo = new THREE.TorusKnotGeometry(1.2, 0.4, 150, 20);
          this.knotMat = new THREE.MeshStandardMaterial({
            color: 0x1c1c24,
            wireframe: true,
            emissive: 0x00f5a0,
            emissiveIntensity: 0.1,
            metalness: 0.8,
            roughness: 0.2,
          });
          this.knot = new THREE.Mesh(knotGeo, this.knotMat);
          this.scene.add(this.knot);
        }

        setState(newState) {
          this.state = newState;
          switch (newState) {
            case "IDLE":
              this.knotMat.emissive.set(0x00f5a0);
              this.knotMat.emissiveIntensity = 0.1;
              this.pointLight.intensity = 2;
              break;
            case "WAITING":
              this.knotMat.emissive.set(0xffffff);
              this.knotMat.emissiveIntensity = 0.4;
              this.pointLight.intensity = 1;
              break;
            case "READY":
              this.knotMat.emissive.set(0x00f5a0);
              this.knotMat.emissiveIntensity = 3.0;
              this.pointLight.intensity = 4;
              break;
            case "ERROR":
              this.knotMat.emissive.set(0xff4d6d);
              this.knotMat.emissiveIntensity = 4.0;
              this.pointLight.intensity = 0.5;
              break;
          }
        }

        onWindowResize() {
          this.camera.aspect = window.innerWidth / window.innerHeight;
          this.camera.updateProjectionMatrix();
          this.renderer.setSize(window.innerWidth, window.innerHeight);
        }

        animate() {
          requestAnimationFrame(() => this.animate());
          const elapsed = this.clock.getElapsedTime();

          let rotSpeed = 1;
          let scaleBase = 1;

          if (this.state === "WAITING") {
            rotSpeed = 0.5;
            scaleBase = 0.95 + Math.sin(elapsed * 5) * 0.05;
          } else if (this.state === "READY") {
            rotSpeed = 10;
            scaleBase = 1.1;
          } else if (this.state === "ERROR") {
            rotSpeed = 0.1;
            scaleBase = 1.0;
            this.knot.position.x = Math.sin(elapsed * 40) * 0.05;
          } else {
            rotSpeed = 1;
            scaleBase = 1 + Math.sin(elapsed) * 0.05;
            this.knot.position.x = 0;
          }

          this.knot.rotation.y += 0.005 * rotSpeed;
          this.knot.rotation.z += 0.003 * rotSpeed;
          this.knot.scale.set(scaleBase, scaleBase, scaleBase);

          this.renderer.render(this.scene, this.camera);
        }
      }

      /**
       * GAME LOGIC
       * Handles timing, stats, and navigation flow.
       */
      class Game {
        constructor() {
          this.sceneManager = new SceneManager();
          this.triggerBox = document.getElementById("trigger-box");
          this.triggerLabel = document.getElementById("trigger-label");

          this.audioCtx = null;
          this.startTime = 0;
          this.timerId = null;
          this.gameState = "START"; // START, WAITING, READY, RESULT

          this.attempts = 0;
          this.times = [];
          this.best = Infinity;

          this.loadStats();
          this.updateStatsUI();
        }

        initAudio() {
          if (!this.audioCtx) {
            this.audioCtx = new (
              window.AudioContext || window.webkitAudioContext
            )();
          }
          if (this.audioCtx.state === "suspended") this.audioCtx.resume();
        }

        playOsc(freq, dur, type = "sine", vol = 0.1) {
          if (!this.audioCtx) return;
          const osc = this.audioCtx.createOscillator();
          const gain = this.audioCtx.createGain();
          osc.type = type;
          osc.frequency.setValueAtTime(freq, this.audioCtx.currentTime);
          gain.gain.setValueAtTime(vol, this.audioCtx.currentTime);
          gain.gain.exponentialRampToValueAtTime(
            0.0001,
            this.audioCtx.currentTime + dur,
          );
          osc.connect(gain);
          gain.connect(this.audioCtx.destination);
          osc.start();
          osc.stop(this.audioCtx.currentTime + dur);
        }

        handleTriggerClick() {
          if (this.gameState === "START" || this.gameState === "RESULT") {
            this.startRound();
          } else if (this.gameState === "WAITING") {
            this.handleEarlyClick();
          } else if (this.gameState === "READY") {
            this.processReaction();
          }
        }

        startRound() {
          this.initAudio();
          this.playOsc(440, 0.05, "sine", 0.05);

          this.gameState = "WAITING";
          this.hideAllModals();
          this.sceneManager.setState("WAITING");

          this.triggerBox.className = "waiting";
          this.triggerLabel.innerText = "Wait...";

          const delay = Math.floor(Math.random() * 3000) + 2000;
          this.timerId = setTimeout(() => this.triggerReady(), delay);
        }

        triggerReady() {
          this.gameState = "READY";
          this.startTime = performance.now();
          this.sceneManager.setState("READY");

          this.triggerBox.className = "ready";
          this.triggerLabel.innerText = "CLICK!";
          this.playOsc(880, 0.15, "sine", 0.1);

          document.body.style.backgroundColor = "rgba(0, 245, 160, 0.1)";
          setTimeout(
            () => (document.body.style.backgroundColor = "var(--bg-color)"),
            60,
          );
        }

        processReaction() {
          const reactionTime = Math.round(performance.now() - this.startTime);
          this.endRound(reactionTime);
        }

        handleEarlyClick() {
          clearTimeout(this.timerId);
          this.gameState = "RESULT";
          this.sceneManager.setState("ERROR");
          this.triggerBox.className = "error";
          this.triggerLabel.innerText = "EARLY";
          this.playOsc(110, 0.3, "sawtooth", 0.05);

          this.showModal("screen-error");
          document
            .getElementById("top-score-display")
            .classList.remove("visible");
        }

        endRound(time) {
          this.gameState = "RESULT";
          this.triggerBox.className = "";
          this.triggerLabel.innerText = "Complete";
          this.sceneManager.setState("IDLE");

          this.attempts++;
          this.times.push(time);
          if (time < this.best) this.best = time;

          this.saveStats();
          this.updateStatsUI();
          this.showTopScore(time);

          // Show Result Modal with Yes/No
          const rating = this.getRating(time);
          document.getElementById("res-modal-title").innerText = `${time}ms`;
          document.getElementById("res-modal-rating").innerHTML =
            `<span class="rating-tag ${rating.class}">${rating.label}</span>`;
          this.showModal("screen-result");
        }

        showTopScore(time) {
          const display = document.getElementById("top-score-display");
          const val = document.getElementById("top-score-value");
          const ratingCont = document.getElementById("top-rating-container");

          val.innerText = `${time}ms`;
          const rating = this.getRating(time);
          ratingCont.innerHTML = `<span class="rating-tag ${rating.class}">${rating.label}</span>`;

          display.classList.add("visible");
        }

        getRating(ms) {
          if (ms < 200) return { label: "Superhuman", class: "superhuman" };
          if (ms < 280) return { label: "Excellent", class: "excellent" };
          if (ms < 350) return { label: "Good", class: "good" };
          if (ms < 450) return { label: "Average", class: "average" };
          return { label: "Slow", class: "bad" };
        }

        showModal(id) {
          this.hideAllModals();
          document.getElementById(id).classList.add("active");
        }

        hideAllModals() {
          document
            .querySelectorAll(".modal")
            .forEach((m) => m.classList.remove("active"));
        }

        goToMainMenu() {
          this.gameState = "START";
          this.triggerBox.className = "";
          this.triggerLabel.innerText = "Initialize";
          this.sceneManager.setState("IDLE");
          this.showModal("screen-start");
          document
            .getElementById("top-score-display")
            .classList.remove("visible");
        }

        updateStatsUI() {
          const bestStr = this.best === Infinity ? "--" : `${this.best}ms`;
          const avg =
            this.times.length > 0
              ? Math.round(
                  this.times.reduce((a, b) => a + b) / this.times.length,
                )
              : "--";
          const avgStr = avg === "--" ? "--" : `${avg}ms`;

          // Update Start Modal Stats
          document.getElementById("stat-best").innerText = bestStr;
          document.getElementById("stat-trials").innerText = this.attempts;
          document.getElementById("stat-avg").innerText = avgStr;

          // Update Persistent Bottom Stats
          document.getElementById("btm-stat-trials").innerText = this.attempts;
          document.getElementById("btm-stat-best").innerText = bestStr;
          document.getElementById("btm-stat-avg").innerText = avgStr;
        }

        saveStats() {
          localStorage.setItem(
            "reaction_stats_v3",
            JSON.stringify({
              best: this.best,
              times: this.times,
              attempts: this.attempts,
            }),
          );
        }

        loadStats() {
          const saved = localStorage.getItem("reaction_stats_v3");
          if (saved) {
            const data = JSON.parse(saved);
            this.best = data.best;
            this.times = data.times;
            this.attempts = data.attempts;
          }
        }

        resetAll() {
          localStorage.removeItem("reaction_stats_v3");
          location.reload();
        }
      }

      let game;
      window.onload = () => {
        game = new Game();
      };
    </script>
  </body>
</html>
